<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcards - Jonas Academy</title>
    <link rel="stylesheet" href="styles/main.css">
    <style>
        html, body {
            overflow-y: auto !important;
            overflow-x: hidden;
        }

        body {
            min-height: 100vh;
            display: block;
            padding: 40px 20px;
        }

        .container {
            width: 100%;
            max-width: 700px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .btn-back {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-light);
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85rem;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .btn-back:hover {
            background: var(--glass-bg-hover);
        }

        .page-title {
            color: #fff;
            font-size: 1.3rem;
            letter-spacing: 2px;
        }

        .module-badge {
            background: rgba(136, 204, 255, 0.2);
            color: #88ccff;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-bottom: 20px;
            display: inline-block;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #88ccff, #66b3ff);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .progress-text {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .flashcard {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 40px 30px;
            min-height: 250px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            margin-bottom: 25px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .flashcard:hover {
            border-color: rgba(136, 204, 255, 0.4);
        }

        .flashcard-label {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 20px;
        }

        .flashcard-content {
            color: #fff;
            font-size: 1.1rem;
            line-height: 1.7;
        }

        .flashcard-answer {
            display: none;
            color: #88ccff;
            font-size: 1rem;
            line-height: 1.7;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .flashcard.revealed .flashcard-answer {
            display: block;
        }

        .flashcard-hint {
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.75rem;
            margin-top: 20px;
        }

        .flashcard.revealed .flashcard-hint {
            display: none;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .nav-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .nav-btn.primary {
            background: linear-gradient(135deg, rgba(136, 204, 255, 0.3), rgba(136, 204, 255, 0.1));
            border-color: rgba(136, 204, 255, 0.5);
        }

        .nav-btn.primary:hover:not(:disabled) {
            background: rgba(136, 204, 255, 0.4);
        }

        .stats {
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
        }

        .stats-count {
            color: #88ccff;
            font-weight: bold;
        }

        .completion-message {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .completion-message.active {
            display: block;
        }

        .completion-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .completion-title {
            color: #fff;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .completion-text {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 25px;
        }

        .btn-restart {
            background: linear-gradient(135deg, rgba(136, 204, 255, 0.3), rgba(136, 204, 255, 0.1));
            border: 1px solid rgba(136, 204, 255, 0.5);
            color: #fff;
            padding: 14px 35px;
            border-radius: 25px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .btn-restart:hover {
            background: rgba(136, 204, 255, 0.4);
        }

        .loading {
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
            padding: 60px 20px;
        }

        @media (max-width: 480px) {
            .header {
                flex-direction: row;
                gap: 15px;
            }

            .page-title {
                font-size: 1rem;
            }

            .flashcard {
                padding: 30px 20px;
                min-height: 200px;
            }

            .flashcard-content {
                font-size: 1rem;
            }

            .navigation {
                flex-wrap: wrap;
            }

            .nav-btn {
                padding: 10px 20px;
                font-size: 0.85rem;
            }
        }
    </style>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- Vercel Analytics -->
    <script defer src="/_vercel/insights/script.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="btn-back">Back</a>
            <h1 class="page-title">Flashcards</h1>
        </div>

        <div class="module-badge">Environmental Engineering - Year 3</div>

        <div id="flashcard-container">
            <p class="loading">Loading flashcards...</p>
        </div>

        <div id="completion-message" class="completion-message">
            <div class="completion-icon">ðŸŽ‰</div>
            <h2 class="completion-title">Well Done!</h2>
            <p class="completion-text">You've completed all the flashcards for today.</p>
            <button class="btn-restart" onclick="restartFlashcards()">Start Again</button>
        </div>
    </div>

    <script src="scripts/firebase-config.js"></script>
    <script>
        let flashcards = [];
        let currentIndex = 0;
        let completedCount = 0;
        let currentUserUid = null;

        // Parse CSV content
        function parseCSV(text) {
            const cards = [];
            const lines = text.split('\n');

            for (let line of lines) {
                line = line.trim();
                if (!line) continue;

                // Handle CSV with quotes
                let question, answer;

                if (line.startsWith('"')) {
                    // Question is quoted
                    const endQuote = line.indexOf('",');
                    if (endQuote > 0) {
                        question = line.substring(1, endQuote);
                        answer = line.substring(endQuote + 2);
                    } else {
                        continue;
                    }
                } else {
                    // Question is not quoted
                    const firstComma = line.indexOf(',');
                    if (firstComma > 0) {
                        question = line.substring(0, firstComma);
                        answer = line.substring(firstComma + 1);
                    } else {
                        continue;
                    }
                }

                // Clean up answer (remove surrounding quotes)
                answer = answer.trim();
                if (answer.startsWith('"') && answer.endsWith('"')) {
                    answer = answer.substring(1, answer.length - 1);
                }

                cards.push({ question, answer });
            }

            return cards;
        }

        // Load flashcards from CSV
        async function loadFlashcards() {
            try {
                const response = await fetch('flashcards/flashcards_env.csv');
                const text = await response.text();
                flashcards = parseCSV(text);

                if (flashcards.length === 0) {
                    document.getElementById('flashcard-container').innerHTML =
                        '<p class="loading">No flashcards available.</p>';
                    return;
                }

                renderFlashcard();
            } catch (error) {
                console.error('Error loading flashcards:', error);
                document.getElementById('flashcard-container').innerHTML =
                    '<p class="loading">Failed to load flashcards.</p>';
            }
        }

        // Render current flashcard
        function renderFlashcard() {
            if (currentIndex >= flashcards.length) {
                // Show completion message
                document.getElementById('flashcard-container').style.display = 'none';
                document.getElementById('completion-message').classList.add('active');
                return;
            }

            const card = flashcards[currentIndex];
            const progress = ((currentIndex + 1) / flashcards.length) * 100;

            document.getElementById('flashcard-container').innerHTML = `
                <p class="progress-text">Card ${currentIndex + 1} of ${flashcards.length}</p>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>

                <div class="flashcard" id="flashcard" onclick="revealAnswer()">
                    <div class="flashcard-label">Question</div>
                    <div class="flashcard-content">${escapeHtml(card.question)}</div>
                    <div class="flashcard-answer">
                        <div class="flashcard-label" style="margin-bottom: 15px;">Answer</div>
                        ${escapeHtml(card.answer)}
                    </div>
                    <div class="flashcard-hint">Click to reveal answer</div>
                </div>

                <div class="navigation">
                    <button class="nav-btn" onclick="previousCard()" ${currentIndex === 0 ? 'disabled' : ''}>Previous</button>
                    <button class="nav-btn primary" onclick="nextCard()">Next</button>
                </div>

                <div class="stats">
                    Completed: <span class="stats-count">${completedCount}</span> flashcards total
                </div>
            `;
        }

        // Reveal answer
        function revealAnswer() {
            const flashcard = document.getElementById('flashcard');
            if (!flashcard.classList.contains('revealed')) {
                flashcard.classList.add('revealed');
            }
        }

        // Go to next card
        async function nextCard() {
            const flashcard = document.getElementById('flashcard');

            // Only count as completed if answer was revealed
            if (flashcard && flashcard.classList.contains('revealed')) {
                completedCount++;

                // Update Firebase
                if (currentUserUid) {
                    try {
                        await db.collection('users').doc(currentUserUid).update({
                            flashcardsCompleted: firebase.firestore.FieldValue.increment(1)
                        });
                    } catch (error) {
                        console.error('Error updating flashcard count:', error);
                    }
                }
            }

            currentIndex++;
            renderFlashcard();
        }

        // Go to previous card
        function previousCard() {
            if (currentIndex > 0) {
                currentIndex--;
                renderFlashcard();
            }
        }

        // Restart flashcards
        function restartFlashcards() {
            currentIndex = 0;
            document.getElementById('flashcard-container').style.display = 'block';
            document.getElementById('completion-message').classList.remove('active');
            renderFlashcard();
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Check auth state and load flashcards
        onAuthStateChange(async (user) => {
            if (user) {
                currentUserUid = user.uid;

                // Get current completed count from Firebase
                const userData = await getUserData(user.uid);
                if (userData && userData.flashcardsCompleted) {
                    completedCount = userData.flashcardsCompleted;
                }
            }

            loadFlashcards();
        });
    </script>
</body>
</html>
