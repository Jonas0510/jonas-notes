<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Jonas Notes</title>
    <link rel="stylesheet" href="styles/main.css">
    <style>
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* Login Container */
        .login-container {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-title {
            color: #fff;
            font-size: 1.5rem;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .login-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 15px 20px;
            color: #fff;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1rem;
            text-align: center;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .login-btn {
            background: var(--accent-blue);
            border: none;
            color: #000;
            padding: 15px 30px;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            opacity: 0.9;
            box-shadow: 0 0 20px rgba(136, 204, 255, 0.4);
        }

        .login-error {
            color: #ff6b6b;
            font-size: 0.9rem;
            display: none;
        }

        /* Admin Dashboard */
        .admin-container {
            display: none;
            width: 100%;
            max-width: 1000px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--glass-border);
        }

        .admin-title {
            color: #fff;
            font-size: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .btn-logout {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-light);
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            background: var(--glass-bg-hover);
        }

        /* Reports Section */
        .reports-section {
            margin-bottom: 30px;
        }

        .section-title {
            color: var(--text-muted);
            font-size: 1rem;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .reports-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .report-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .report-card:hover {
            border-color: var(--accent-blue);
        }

        .report-card.resolved {
            opacity: 0.6;
            border-color: #66ff66;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .report-info {
            flex: 1;
        }

        .report-pdf {
            color: #fff;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .report-meta {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .report-page {
            background: var(--accent-blue);
            color: #000;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .report-description {
            color: var(--text-light);
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
        }

        .report-actions {
            display: flex;
            gap: 10px;
        }

        .btn-resolve {
            background: rgba(102, 255, 102, 0.2);
            border: 1px solid rgba(102, 255, 102, 0.5);
            color: #66ff66;
            padding: 8px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .btn-resolve:hover {
            background: rgba(102, 255, 102, 0.3);
        }

        .btn-delete {
            background: rgba(255, 100, 100, 0.2);
            border: 1px solid rgba(255, 100, 100, 0.5);
            color: #ff9999;
            padding: 8px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .btn-delete:hover {
            background: rgba(255, 100, 100, 0.3);
        }

        .resolved-badge {
            background: rgba(102, 255, 102, 0.2);
            color: #66ff66;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.75rem;
        }

        .no-reports, .no-announcements {
            color: var(--text-muted);
            text-align: center;
            padding: 40px;
            font-style: italic;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab-btn {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            padding: 12px 25px;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            background: var(--glass-bg-hover);
        }

        .tab-btn.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: #000;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Announcement Styles */
        .announcement-form {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .form-group input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 10px 15px;
            color: #fff;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .btn-add {
            background: var(--accent-blue);
            border: none;
            color: #000;
            padding: 10px 25px;
            border-radius: 15px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-add:hover {
            opacity: 0.9;
            box-shadow: 0 0 15px rgba(136, 204, 255, 0.4);
        }

        .announcement-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .announcement-card:hover {
            border-color: rgba(136, 204, 255, 0.5);
        }

        .announcement-info {
            flex: 1;
        }

        .announcement-date-badge {
            background: rgba(136, 204, 255, 0.2);
            color: #88ccff;
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-right: 10px;
        }

        .announcement-title-text {
            color: #fff;
            font-size: 0.9rem;
        }

        .announcement-subtitle-text {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .announcements-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Newsletter Subscribers */
        .subscribers-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .subscriber-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .subscriber-card:hover {
            border-color: rgba(136, 204, 255, 0.5);
        }

        .subscriber-info {
            flex: 1;
        }

        .subscriber-email {
            color: #fff;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .subscriber-name {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .subscriber-date {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .no-subscribers {
            color: var(--text-muted);
            text-align: center;
            padding: 40px;
            font-style: italic;
        }

        .export-btn {
            background: rgba(102, 255, 102, 0.2);
            border: 1px solid rgba(102, 255, 102, 0.5);
            color: #66ff66;
            padding: 10px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .export-btn:hover {
            background: rgba(102, 255, 102, 0.3);
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            flex: 1;
            text-align: center;
        }

        .stat-number {
            color: #fff;
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .login-container {
                padding: 30px 20px;
            }

            .admin-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .stats {
                flex-direction: column;
            }

            .report-header {
                flex-direction: column;
                gap: 10px;
            }

            .report-actions {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
        <h1 class="login-title">Admin Login</h1>
        <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 0.85rem;">Sign in with your admin Google account</p>
        <button id="google-login-btn" class="login-btn">
            <span style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                <svg width="18" height="18" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign in with Google
            </span>
        </button>
        <p id="login-error" class="login-error">Access denied. Admin account required.</p>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="admin-container">
        <div class="admin-header">
            <h1 class="admin-title">Admin Dashboard</h1>
            <button id="logout-btn" class="btn-logout">Logout</button>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('reports')">Reports</button>
            <button class="tab-btn" onclick="switchTab('announcements')">Announcements</button>
            <button class="tab-btn" onclick="switchTab('newsletter')">Newsletter</button>
        </div>

        <!-- Reports Tab -->
        <div id="reports-tab" class="tab-content active">
            <div class="stats">
                <div class="stat-card">
                    <div id="total-reports" class="stat-number">0</div>
                    <div class="stat-label">Total Reports</div>
                </div>
                <div class="stat-card">
                    <div id="pending-reports" class="stat-number">0</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card">
                    <div id="resolved-reports" class="stat-number">0</div>
                    <div class="stat-label">Resolved</div>
                </div>
            </div>

            <div class="reports-section">
                <h2 class="section-title">Pending Reports</h2>
                <div id="pending-list" class="reports-list">
                    <p class="no-reports">No pending reports</p>
                </div>
            </div>

            <div class="reports-section">
                <h2 class="section-title">Resolved Reports</h2>
                <div id="resolved-list" class="reports-list">
                    <p class="no-reports">No resolved reports</p>
                </div>
            </div>
        </div>

        <!-- Announcements Tab -->
        <div id="announcements-tab" class="tab-content">
            <div class="announcement-form">
                <h2 class="section-title">Add New Announcement</h2>
                <form id="add-announcement-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date</label>
                            <input type="text" id="announcement-date" placeholder="DD/MM/YYYY" required>
                        </div>
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" id="announcement-title" placeholder="Announcement title" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Subtitle (optional)</label>
                            <input type="text" id="announcement-subtitle" placeholder="Optional subtitle">
                        </div>
                        <div class="form-group" style="flex: 0; align-self: flex-end;">
                            <button type="submit" class="btn-add">Add</button>
                        </div>
                    </div>
                </form>
            </div>

            <h2 class="section-title">All Announcements</h2>
            <div id="announcements-list" class="announcements-list">
                <p class="no-announcements">No announcements</p>
            </div>
        </div>

        <!-- Newsletter Tab -->
        <div id="newsletter-tab" class="tab-content">
            <div class="stats">
                <div class="stat-card">
                    <div id="total-subscribers" class="stat-number">0</div>
                    <div class="stat-label">Total Subscribers</div>
                </div>
            </div>

            <button id="export-subscribers" class="export-btn">Export Emails (CSV)</button>

            <h2 class="section-title">Newsletter Subscribers</h2>
            <div id="subscribers-list" class="subscribers-list">
                <p class="no-subscribers">Loading subscribers...</p>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="scripts/firebase-config.js"></script>

    <script>
        // Admin email - only this account can access admin dashboard
        const ADMIN_EMAIL = 'jonaslaww@gmail.com';

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const adminDashboard = document.getElementById('admin-dashboard');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');

        // Check auth state on page load
        onAuthStateChange((user) => {
            if (user && user.email === ADMIN_EMAIL) {
                showDashboard();
            } else if (user) {
                // User is logged in but not admin - show error and sign out
                loginError.style.display = 'block';
                signOutUser();
            } else {
                // Not logged in
                loginScreen.style.display = 'block';
                adminDashboard.style.display = 'none';
                loginError.style.display = 'none';
            }
        });

        // Google login button
        googleLoginBtn.addEventListener('click', async () => {
            try {
                const user = await signInWithGoogle();
                if (user.email !== ADMIN_EMAIL) {
                    loginError.style.display = 'block';
                    await signOutUser();
                }
            } catch (error) {
                console.error('Login error:', error);
                loginError.textContent = 'Login failed. Please try again.';
                loginError.style.display = 'block';
            }
        });

        // Logout
        logoutBtn.addEventListener('click', async () => {
            await signOutUser();
            loginScreen.style.display = 'block';
            adminDashboard.style.display = 'none';
            loginError.style.display = 'none';
        });

        // Show dashboard
        function showDashboard() {
            loginScreen.style.display = 'none';
            adminDashboard.style.display = 'block';
            loadReports();
            loadAnnouncements();
        }

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase() === tabName) {
                    btn.classList.add('active');
                }
            });

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // Load and display reports
        function loadReports() {
            const reports = JSON.parse(localStorage.getItem('jonasnotes_reports') || '[]');

            // Sort by timestamp (newest first)
            reports.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            const pending = reports.filter(r => !r.resolved);
            const resolved = reports.filter(r => r.resolved);

            // Update stats
            document.getElementById('total-reports').textContent = reports.length;
            document.getElementById('pending-reports').textContent = pending.length;
            document.getElementById('resolved-reports').textContent = resolved.length;

            // Render lists
            renderReportList('pending-list', pending);
            renderReportList('resolved-list', resolved);
        }

        // Render a list of reports
        function renderReportList(containerId, reports) {
            const container = document.getElementById(containerId);

            if (reports.length === 0) {
                container.innerHTML = '<p class="no-reports">No reports</p>';
                return;
            }

            container.innerHTML = reports.map(report => `
                <div class="report-card ${report.resolved ? 'resolved' : ''}" data-id="${report.id}">
                    <div class="report-header">
                        <div class="report-info">
                            <div class="report-pdf">${escapeHtml(report.pdf)}</div>
                            <div class="report-meta">
                                Year ${report.year} / ${escapeHtml(report.module)} &bull;
                                ${formatDate(report.timestamp)}
                            </div>
                        </div>
                        <span class="report-page">Page ${report.page}</span>
                    </div>
                    <div class="report-description">${escapeHtml(report.description)}</div>
                    <div class="report-actions">
                        ${report.resolved
                            ? '<span class="resolved-badge">Resolved</span>'
                            : `<button class="btn-resolve" onclick="resolveReport(${report.id})">Mark Resolved</button>`
                        }
                        <button class="btn-delete" onclick="deleteReport(${report.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Resolve a report
        function resolveReport(id) {
            const reports = JSON.parse(localStorage.getItem('jonasnotes_reports') || '[]');
            const report = reports.find(r => r.id === id);
            if (report) {
                report.resolved = true;
                localStorage.setItem('jonasnotes_reports', JSON.stringify(reports));
                loadReports();
            }
        }

        // Delete a report
        function deleteReport(id) {
            if (!confirm('Are you sure you want to delete this report?')) return;

            let reports = JSON.parse(localStorage.getItem('jonasnotes_reports') || '[]');
            reports = reports.filter(r => r.id !== id);
            localStorage.setItem('jonasnotes_reports', JSON.stringify(reports));
            loadReports();
        }

        // Format date
        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Default announcements
        const DEFAULT_ANNOUNCEMENTS = [
            { date: '15/12/2024', title: 'Fixed website layout issues on phone', subtitle: '' },
            { date: '14/12/2024', title: 'Added environmental engineering year 3 notes', subtitle: '' },
            { date: '14/12/2024', title: 'Added a report button - do report any errors!', subtitle: '' }
        ];

        // Load and display announcements
        function loadAnnouncements() {
            let announcements = JSON.parse(localStorage.getItem('jonasnotes_announcements'));

            // If no announcements in storage, use defaults
            if (!announcements || announcements.length === 0) {
                announcements = DEFAULT_ANNOUNCEMENTS;
                localStorage.setItem('jonasnotes_announcements', JSON.stringify(announcements));
            }

            const announcementsList = document.getElementById('announcements-list');

            if (announcements.length === 0) {
                announcementsList.innerHTML = '<p class="no-announcements">No announcements</p>';
                return;
            }

            announcementsList.innerHTML = announcements.map((a, index) => `
                <div class="announcement-card">
                    <div class="announcement-info">
                        <span class="announcement-date-badge">${a.date}</span>
                        <span class="announcement-title-text">${escapeHtml(a.title)}</span>
                        ${a.subtitle ? `<p class="announcement-subtitle-text">${escapeHtml(a.subtitle)}</p>` : ''}
                    </div>
                    <button class="btn-delete" onclick="deleteAnnouncement(${index})">Delete</button>
                </div>
            `).join('');
        }

        // Add announcement form
        document.getElementById('add-announcement-form').addEventListener('submit', (e) => {
            e.preventDefault();

            const date = document.getElementById('announcement-date').value;
            const title = document.getElementById('announcement-title').value;
            const subtitle = document.getElementById('announcement-subtitle').value;

            let announcements = JSON.parse(localStorage.getItem('jonasnotes_announcements') || '[]');

            // Add new announcement at the beginning
            announcements.unshift({ date, title, subtitle });

            localStorage.setItem('jonasnotes_announcements', JSON.stringify(announcements));

            // Reset form
            document.getElementById('announcement-date').value = '';
            document.getElementById('announcement-title').value = '';
            document.getElementById('announcement-subtitle').value = '';

            loadAnnouncements();
        });

        // Delete announcement
        function deleteAnnouncement(index) {
            if (!confirm('Are you sure you want to delete this announcement?')) return;

            let announcements = JSON.parse(localStorage.getItem('jonasnotes_announcements') || '[]');
            announcements.splice(index, 1);
            localStorage.setItem('jonasnotes_announcements', JSON.stringify(announcements));
            loadAnnouncements();
        }

        // Set today's date as default
        function setDefaultDate() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            document.getElementById('announcement-date').value = `${day}/${month}/${year}`;
        }

        // Set default date on page load
        setDefaultDate();

        // Newsletter Subscribers
        let subscribers = [];

        // Load newsletter subscribers from Firestore
        async function loadSubscribers() {
            const subscribersList = document.getElementById('subscribers-list');
            const totalSubscribers = document.getElementById('total-subscribers');

            try {
                // Fetch all users and filter client-side (avoids needing Firestore index)
                const snapshot = await db.collection('users').get();

                subscribers = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Only include users who have subscribed to newsletter
                    if (data.newsletterSubscribed === true) {
                        subscribers.push({
                            id: doc.id,
                            email: data.email || 'No email',
                            fullName: data.fullName || 'Unknown',
                            subscribedAt: data.newsletterSubscribedAt || null
                        });
                    }
                });

                // Sort by subscription date (newest first)
                subscribers.sort((a, b) => {
                    if (!a.subscribedAt) return 1;
                    if (!b.subscribedAt) return -1;
                    return new Date(b.subscribedAt) - new Date(a.subscribedAt);
                });

                // Update stats
                totalSubscribers.textContent = subscribers.length;

                // Render list
                if (subscribers.length === 0) {
                    subscribersList.innerHTML = '<p class="no-subscribers">No newsletter subscribers yet</p>';
                    return;
                }

                subscribersList.innerHTML = subscribers.map(sub => `
                    <div class="subscriber-card">
                        <div class="subscriber-info">
                            <div class="subscriber-email">${escapeHtml(sub.email)}</div>
                            <div class="subscriber-name">${escapeHtml(sub.fullName)}</div>
                            ${sub.subscribedAt ? `<div class="subscriber-date">Subscribed: ${formatDate(sub.subscribedAt)}</div>` : ''}
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading subscribers:', error);
                // Show more detailed error message
                let errorMsg = 'Error loading subscribers.';
                if (error.code === 'permission-denied') {
                    errorMsg = 'Permission denied. Update your Firestore security rules to allow reading the users collection.';
                } else if (error.message) {
                    errorMsg = `Error: ${error.message}`;
                }
                subscribersList.innerHTML = `<p class="no-subscribers">${errorMsg}</p>`;
            }
        }

        // Export subscribers to CSV
        document.getElementById('export-subscribers').addEventListener('click', () => {
            if (subscribers.length === 0) {
                alert('No subscribers to export');
                return;
            }

            // Create CSV content
            const csvHeader = 'Email,Name,Subscribed Date\n';
            const csvRows = subscribers.map(sub => {
                const date = sub.subscribedAt ? new Date(sub.subscribedAt).toLocaleDateString() : '';
                return `"${sub.email}","${sub.fullName}","${date}"`;
            }).join('\n');

            const csvContent = csvHeader + csvRows;

            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `newsletter_subscribers_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Modify showDashboard to also load subscribers
        const originalShowDashboard = showDashboard;
        showDashboard = function() {
            loginScreen.style.display = 'none';
            adminDashboard.style.display = 'block';
            loadReports();
            loadAnnouncements();
            loadSubscribers();
        };
    </script>
</body>
</html>
